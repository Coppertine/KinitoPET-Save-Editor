[gd_scene load_steps=3 format=2]

[ext_resource path="res://Table.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Node2D

var save = {}

# Default data for SAVE.data
var default_data = {\"win\":false, \"PostRunAnimation\":false, \"WP\":\"\", \"name\":\"\", \"namefound\":0, \"tts_sn\":0, \"sp\":0, \"dataSP\":0, \"dfs\":0, \"ContAcc\":0, \"RESET\":false, \"KCount\":0, \"Colour\":\"\", \"name_valid\":false, \"colour_valid\":false, \"emailBox\":[], \"lastSave\":\"never\", \"Endings\":[], \"Memory\":[], \"postgame\":false, \"PLAYER_FavWord\":\"\", \"PLAYER_Super\":\"\", \"PLAYER_redyrepair\":{}, \"PP_Painting\":false, \"Act1_hang\":false, \"BDAY\":0, \"BMONTH\":0, \"LastName\":\"\", \"ACT3_Weather\":\"\", \"ACT3_Place\":\"\", \"F_Food\":\"\", \"F_Game\":\"\", \"PET_Name\":\"\", \"PET_Type\":\"\"}
var modifyingSave = {}

# Called when the node enters the scene tree for the first time.
func _ready():
	pass # Replace with function body.


# Called every frame. 'delta' is the elapsed time since the previous frame.
#func _process(delta):
#	pass

func _on_Button_pressed():
	var file_path = get_node(\"SavePathBox\").text
	_open_file(file_path)
	pass


func _open_file(file_path):
	var file = File.new()
	if(!file.file_exists(file_path)):
		print(\"ERROR: Can not find save file.\")
		return false
	var err = file.open_encrypted_with_pass(file_path, File.READ, OS.get_unique_id())
	if(err != OK):
		print(\"ERROR: Unable to open file, please ensure this is loaded on the same computer the save file was created on.\")
		return false
	save = file.get_var()
	file.close()
	print(save)
	_fill_table()
	pass


func _fill_table():
	var table_node = get_node(\"Table\")
	if(table_node.get_row_count() > 0):
		table_node.clear_rows()
	for key in save:
		print(key)
		var value = str(save[key])
		if(value == \"True\" or value == \"False\"):
			value = value.to_lower()
		print(value)
		table_node.CreateNewDataRow(key,value)
		pass
	pass
	
func _get_table():
	var table_node = get_node(\"Table\")
	modifyingSave = table_node.GetDataRows()
	modifyingSave = reformat_save(modifyingSave) 
	## Because editor assumes everything is a string... we need to convert back
	print(modifyingSave)
	pass


func _on_Button2_pressed():
	_get_table()
	var file = File.new()
	var file_path = get_node(\"SavePathBox\").text
	if(file.file_exists(file_path)):
		# we just want to make a backup of it
		var bak_file_path = file_path + \".bak\"
		var dir = Directory.new()
		if(file.file_exists(bak_file_path)):
			dir.remove(bak_file_path)
		dir.rename(file_path, bak_file_path)
		print(\"A backup is made to: \" + bak_file_path)
	file.open_encrypted_with_pass(file_path, File.WRITE, OS.get_unique_id())
	file.store_var(modifyingSave)
	file.close()
	print(\"Saved to: \" + file_path)
	pass # Replace with function body.

func reformat_save(mod_save):
	for key in mod_save:
#		print(\"key type of \", save[key] ,\" is: \", str(typeof(default_data[key])))
#		match typeof(default_data[key]):
#			TYPE_BOOL:
#				print(\"bool, changing\")
#				# LETS HOPE this is either 0 or 1
#				mod_save[key] = bool(int(mod_save[key]))
#			TYPE_STRING:
#				print(\"string, not changing\")
#			TYPE_INT:
#				mod_save[key] = int(mod_save[key])
		mod_save[key] = str2var(mod_save[key])
			
	return mod_save
"

[node name="Node2D" type="Node2D"]
script = SubResource( 1 )

[node name="Panel" type="Panel" parent="."]
margin_right = 1023.0
margin_bottom = 599.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="SavePathBox" type="LineEdit" parent="."]
margin_left = 12.0
margin_top = 12.4703
margin_right = 336.0
margin_bottom = 36.4703
hint_tooltip = "Absolute Path to SAVE.data"
placeholder_text = "SAVE.data path"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Button" type="Button" parent="."]
margin_left = 354.0
margin_top = 12.0
margin_right = 441.0
margin_bottom = 34.5
text = "Open"
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Table" parent="." instance=ExtResource( 1 )]
size_flags_horizontal = 3

[node name="Button2" type="Button" parent="."]
margin_left = 928.352
margin_top = 562.378
margin_right = 1011.35
margin_bottom = 590.378
text = "Save"
__meta__ = {
"_edit_use_anchors_": false
}

[connection signal="pressed" from="Button" to="." method="_on_Button_pressed"]
[connection signal="pressed" from="Button2" to="." method="_on_Button2_pressed"]
